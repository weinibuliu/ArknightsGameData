name: Yostar

on:
    workflow_call:
      inputs:
        lang:
          required: true
          type: string
        timezone:
          required: true
          type: string
        timestamp:
          required: true
          type: string
      outputs:
        release:
          value: ${{ jobs.Build.outputs.RELEASE }}
        ver:
          value: ${{ jobs.Build.outputs.ver }}

jobs:
    Build:
        runs-on: macos-latest
        steps:
        - name: Checkout Code
          uses: actions/checkout@v4.2.1

        - name: Checkout ArknightsGameResource
          uses: actions/checkout@v4.2.1
          with:
            repository: Kengxxiao/ArknightsGameData_YoStar
            ref: main
            path: cache
            sparse-checkout: |
              ${{ inputs.lang }}/gamedata/excel/character_table.json

        - name: Set Timezone
          uses: szenius/set-timezone@v1.1
          with:
            timezoneMacos: ${{ inputs.timezone }}

        - name: Setup Python
          uses: actions/setup-python@v5.2.0
          with:
            python-version: '3.12'

        - name: Download Avatar
          uses: actions/download-artifact@v4.1.8
          with:
            name: zh_CN-only-avatar-${{ inputs.timestamp }}
            path: cache/${{ inputs.lang }}/avatar

        - name: Run build.py
          timeout-minutes: 2
          run: |
              pip install --upgrade pip
              pip install -r requirements.txt
              mkdir -p version/${{ inputs.lang }}
              python build.py ${{ inputs.lang }} ${{ secrets.GITHUB_TOKEN }}

        - name: Upload Avatar Artifact
          uses: actions/upload-artifact@v4.4.1
          with:
            name: ${{ inputs.lang }}-only-avatar-${{ inputs.timestamp }}
            path: |
              build/avatar/*

        - name: Upload Release Artifact
          uses: actions/upload-artifact@v4.4.1
          with:
            name: ${{ inputs.lang }}-${{ inputs.timestamp }}
            path: build/*

        outputs:
          release: ${{ env.RELEASE }}
          ver: ${{ env.VER }}
